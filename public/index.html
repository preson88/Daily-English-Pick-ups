<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily English Pick-ups</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg-color: #f7f6f2; --text-color: #2c3e50; --card-bg: #ffffff; --border-color: #e8e6e1;
      --sub-text: #7f8c8d; --input-bg: #fdfdfd; --note-bg: #ffffff; --original-box-bg: #fdfaf4;
      --point-color: #f39c12; 
    }
    body.dark-mode {
      --bg-color: #1a1a1a; --text-color: #ecf0f1; --card-bg: #2c2c2c; --border-color: #3d3d3d;
      --sub-text: #95a5a6; --input-bg: #1a1a1a; --note-bg: #2c2c2c; --original-box-bg: #3d3d3d;
    }

    body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 15px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; transition: background-color 0.3s, color 0.3s; }
    .container { width: 100%; max-width: 600px; margin-top: 20px; position: relative; }
    
    #themeToggleBtn { position: absolute; top: -10px; right: 0; background: none; border: none; font-size: 24px; color: var(--point-color); cursor: pointer; transition: transform 0.2s; }
    #themeToggleBtn:hover { transform: scale(1.1); }

    .header-area { text-align: center; margin-bottom: 25px; margin-top: 20px; }
    .main-title { font-size: 28px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; color: var(--text-color); cursor: pointer; }

    .top-menu-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-bottom: 25px; }
    .menu-btn { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px 14px; font-size: 12px; font-weight: 700; color: var(--text-color); cursor: pointer; display: flex; align-items: center; gap: 6px; }

    .input-card { background-color: var(--card-bg); border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03); margin-bottom: 20px; border: 1px solid var(--border-color); }
    .input-label { font-size: 13px; font-weight: 700; margin-bottom: 12px; display: block; }
    .input-box { display: flex; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 4px; }
    #koreanInput { flex: 1; border: none; background: transparent; padding: 10px; font-size: 15px; outline: none; color: var(--text-color); width: 100%; }
    #generateBtn { background-color: #3b82f6; color: white; border: none; border-radius: 6px; padding: 10px 15px; font-weight: 700; cursor: pointer; white-space: nowrap; }

    #result-screen, #archive-screen, #flashcard-screen, #loading-screen { display: none; }

    /* ìº¡ì²˜ ì˜ì—­ (A4 íƒ€ê²Ÿ) */
    #capture-area { background-color: var(--note-bg); padding: 30px 20px; border-radius: 12px; color: var(--text-color); margin-bottom: 20px; }
    .note-header { font-size: 20px; font-weight: 700; margin-bottom: 15px; border-bottom: 2px solid var(--text-color); padding-bottom: 10px; }
    .original-sentence-box { background-color: var(--original-box-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; text-align: center; font-style: italic; margin-bottom: 30px; }
    
    .section-block { margin-bottom: 25px; }
    .section-title { font-size: 14px; font-weight: 700; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .speaker-btn { background: none; border: none; font-size: 16px; color: #9ca3af; cursor: pointer; }
    .english-text { font-family: 'Georgia', serif; font-size: 18px; margin-bottom: 8px; font-weight: bold; }
    .korean-text { font-size: 14px; color: var(--sub-text); margin-bottom: 12px; }
    .tip-box { padding: 12px; border-radius: 8px; font-size: 12px; display: flex; gap: 8px; border: 1px solid rgba(0,0,0,0.1); }

    .voca-title { font-size: 16px; font-weight: 700; margin-bottom: 15px; border-top: 2px solid var(--text-color); padding-top: 20px; }
    .voca-item { display: flex; align-items: center; padding: 10px 0; font-size: 14px; border-bottom: 1px solid var(--border-color); }
    .voca-word { font-weight: 700; margin: 0 8px; }

    .ad-banner { width: 100%; height: 60px; background-color: var(--input-bg); border: 1px dashed #cbd5e1; border-radius: 8px; display: flex; justify-content: center; align-items: center; color: #9ca3af; font-size: 12px; margin-bottom: 20px; }
  </style>
</head>
<body>

  <div class="container">
    <button id="themeToggleBtn"><i class="fas fa-moon"></i></button>

    <div class="header-area">
      <div class="main-title" onclick="location.reload()">Daily English Pick-ups</div>
      <div class="top-menu-row">
        <button class="menu-btn" onclick="openArchive()"><i class="fas fa-archive"></i> ë³´ê´€í•¨</button>
        <button id="saveImgBtn" class="menu-btn"><i class="fas fa-image"></i> PNG ì €ì¥</button>
        <button id="savePdfBtn" class="menu-btn"><i class="fas fa-file-pdf"></i> PDF ì €ì¥</button>
      </div>
    </div>

    <div id="main-screen">
      <div class="input-card">
        <label class="input-label">í•™ìŠµí•  í•œêµ­ì–´ ë¬¸ì¥</label>
        <div class="input-box">
          <input type="text" id="koreanInput" placeholder="ì˜ˆ: ë°°ê³ íŒŒ, í”¼ì ë¨¹ê³  ì‹¶ë‹¤">
          <button id="generateBtn"><i class="far fa-paper-plane"></i> ìƒì„±</button>
        </div>
      </div>
      <div class="ad-banner">Google AdMob ë°°ë„ˆ ê´‘ê³  (ë©”ì¸)</div>
    </div>

    <div id="loading-screen" style="text-align:center; padding:50px;">
      <i class="fas fa-spinner fa-spin" style="font-size:40px; color:#3b82f6;"></i>
      <p>AI ë¶„ì„ ì¤‘...</p>
    </div>

    <div id="result-screen">
      <div class="ad-banner" data-html2canvas-ignore="true">ê´‘ê³ ëŠ” ì €ì¥ ì‹œ ì œì™¸ë©ë‹ˆë‹¤</div>
      <div id="capture-area">
        <div class="note-header">ğŸ“ ì˜¤ëŠ˜ì˜ ì¤ì¤ ì˜ì–´ ë…¸íŠ¸</div>
        <div class="original-sentence-box">"<span id="inputSentenceDisplay"></span>"</div>
        <div id="resultContent"></div>
        <div class="voca-title">ğŸ’ ì¤ì¤ ë‹¨ì–´ì¥</div>
        <ul id="vocaListContainer" style="list-style:none; padding:0;"></ul>
      </div>
      <button class="menu-btn" onclick="location.reload()" style="margin: 0 auto;">ì²˜ìŒìœ¼ë¡œ</button>
    </div>

    <div id="archive-screen">
        <div class="ad-banner">Google ê´‘ê³  (ë³´ê´€í•¨ ìƒë‹¨)</div>
        <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid var(--border-color);">
        <ul id="sentenceList" style="list-style:none; padding:0;"></ul>
        <button class="menu-btn" onclick="location.reload()">ë‹«ê¸°</button>
    </div>
  </div>

  <script>
    // 1. ë°œìŒ ê¸°ëŠ¥
    function speak(text) {
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US';
      window.speechSynthesis.speak(u);
    }

    // 2. ìƒì„± ë²„íŠ¼
    document.getElementById('generateBtn').onclick = async () => {
      const input = document.getElementById('koreanInput').value;
      if(!input.trim()) return;
      document.getElementById('main-screen').style.display = 'none';
      document.getElementById('loading-screen').style.display = 'block';

      try {
        const res = await fetch('/api/generate', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({currentInput: input})
        });
        const data = await res.json();
        renderResult(input, data);
      } catch(e) { alert('ì˜¤ë¥˜ ë°œìƒ'); location.reload(); }
    };

    function renderResult(original, data) {
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('result-screen').style.display = 'block';
      document.getElementById('inputSentenceDisplay').innerText = original;

      const types = [
        {key: 'standard', label: 'STANDARD'},
        {key: 'native', label: 'NATIVE'},
        {key: 'slang', label: 'SLANG'}
      ];

      let html = '';
      types.forEach((t, i) => {
        const item = data[t.key];
        html += `
          <div class="section-block">
            <div class="section-title">
              <div>${i+1}. ${t.label}</div>
              <button class="speaker-btn" onclick="speak('${item.en.replace(/'/g, "\\'")}')"><i class="fas fa-volume-up"></i></button>
            </div>
            <div class="english-text">"${item.en}"</div>
            <div class="korean-text">=> ${item.ko}</div>
            <div class="tip-box">ğŸ’¡ <b>íŒ:</b> ${item.tip}</div>
          </div>`;
      });
      document.getElementById('resultContent').innerHTML = html;

      const vocaHtml = data.voca.map(v => `
        <li class="voca-item">
          <span>${v.emoji}</span>
          <span class="voca-word">${v.word}</span>
          <span style="color:var(--sub-text)">: ${v.meaning}</span>
        </li>`).join('');
      document.getElementById('vocaListContainer').innerHTML = vocaHtml;

      // ë³´ê´€í•¨ ì €ì¥ ë¡œì§
      let history = JSON.parse(localStorage.getItem('mySentences') || '[]');
      if(!history.includes(original)) history.push(original);
      localStorage.setItem('mySentences', JSON.stringify(history));
      localStorage.setItem('data_' + original, JSON.stringify(data));
    }

    // 3. íŒŒì¼ ì €ì¥ (A4 ëŒ€ì‘)
    async function saveFile(type) {
      const area = document.getElementById('capture-area');
      const canvas = await html2canvas(area, {scale: 2});
      const img = canvas.toDataURL('image/png');
      if(type === 'png') {
        const a = document.createElement('a'); a.download = 'note.png'; a.href = img; a.click();
      } else {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        pdf.addImage(img, 'PNG', 0, 0, 210, (canvas.height * 210) / canvas.width);
        pdf.save('note.pdf');
      }
    }
    document.getElementById('saveImgBtn').onclick = () => saveFile('png');
    document.getElementById('savePdfBtn').onclick = () => saveFile('pdf');

    // 4. ë³´ê´€í•¨
    function openArchive() {
      document.getElementById('main-screen').style.display = 'none';
      document.getElementById('archive-screen').style.display = 'block';
      const list = JSON.parse(localStorage.getItem('mySentences') || '[]');
      document.getElementById('sentenceList').innerHTML = list.map(s => 
        `<li onclick="loadHistory('${s}')" style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;">${s}</li>`).join('');
    }
    window.loadHistory = (s) => {
        const data = JSON.parse(localStorage.getItem('data_' + s));
        document.getElementById('archive-screen').style.display = 'none';
        renderResult(s, data);
    };

    // í…Œë§ˆ í† ê¸€
    document.getElementById('themeToggleBtn').onclick = () => {
        document.body.classList.toggle('dark-mode');
    };
  </script>
</body>
</html>